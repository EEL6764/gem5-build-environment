name: Scheduled Build and Test

on:
  schedule:
    # Run weekly on Sunday at 00:00 UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Test build with latest gem5
  test-latest-gem5:
    name: Test with Latest gem5
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build with main branch
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64
          push: false
          load: true
          tags: gem5:latest-test
          build-args: |
            GEM5_VERSION=main

      - name: Run health check
        run: |
          docker run --name gem5-latest -d gem5:latest-test tail -f /dev/null
          sleep 5
          docker exec gem5-latest /usr/local/bin/healthcheck.sh
          docker exec gem5-latest bash -c "cd /opt/gem5 && git log -1 --oneline"
          docker stop gem5-latest
          docker rm gem5-latest

  # Test on multiple base images
  test-base-images:
    name: Test Base Image (${{ matrix.base }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        base:
          - ubuntu:22.04
          - ubuntu:24.04
          - debian:bookworm

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build with ${{ matrix.base }}
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64
          push: false
          load: true
          tags: gem5:${{ matrix.base }}
          build-args: |
            BASE_IMAGE=${{ matrix.base }}
            GEM5_VERSION=class

      - name: Run health check
        run: |
          CONTAINER_NAME=$(echo "gem5-${{ matrix.base }}" | tr ':' '-')
          docker run --name $CONTAINER_NAME -d gem5:${{ matrix.base }} tail -f /dev/null
          sleep 5
          docker exec $CONTAINER_NAME /usr/local/bin/healthcheck.sh
          docker stop $CONTAINER_NAME
          docker rm $CONTAINER_NAME

  # Notification job
  notify:
    name: Notify on Failure
    needs: [test-latest-gem5, test-base-images]
    runs-on: ubuntu-latest
    if: failure()

    steps:
      - name: Create issue on failure
        uses: actions/github-script@v7
        with:
          script: |
            const title = `Scheduled build failed on ${new Date().toISOString().split('T')[0]}`;
            const body = `The scheduled gem5 Docker build has failed.\n\nWorkflow run: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['bug', 'ci-failure']
            });
